"use strict";

function LineGraph(elementId, data) {
  this.wrapper = document.getElementById(elementId);
  this.data = data
  this.height = this._style('height');
  this.width = this._style('width');
  this.$chart = d3.select(this.wrapper).append('svg');
  this.margins = {
    top: 20,
    right: 20,
    bottom: 20,
    left: 50
  };
};


/**
 * Get a computed style for the chart's wrapper div
 */
LineGraph.prototype._style = function(property) {
  var style = window.getComputedStyle(this.wrapper)[property];
  return style.replace('px', '');
};

/**
 * Set up the chart's X axis
 */
LineGraph.prototype._setAxisX = function() {
  this.xAxis = d3.svg.axis()
    .scale(this.xRange)
    .tickSize(2)
    .tickSubdivide(true);
};

/**
 * Append the chart's X asis to the DOM
 */
LineGraph.prototype._appendAxisX = function() {
  this._setAxisX();
  var height = this.height - this.margins.bottom;
  this.$chart.append('svg:g')
    .attr('class', 'x axis')
    .attr('transform', 'translate(0,' + height + ')')
    .call(this.xAxis);
};

/**
 * Set up the chart's Y axis
 */
LineGraph.prototype._setAxisY = function() {
  this.yAxis = d3.svg.axis()
    .scale(this.yRange)
    .tickSize(2)
    .orient('left')
    .tickSubdivide(true);
};

/**
 * Append the chart's Y asis to the DOM
 */
LineGraph.prototype._appendAxisY = function() {
  this._setAxisY();
  this.$chart.append('svg:g')
    .attr('class', 'y axis')
    .attr('transform', 'translate(' + this.margins.left + ',0)')
    .call(this.yAxis);
};

/**
 * Set the min/max range for the X axis.
 * This takes into account the available space, minus margins,
 * and the length of the data array.
 */
LineGraph.prototype._setRangeX = function() {
  var width = this.width - this.margins.right;
  this.xRange = d3.scale.linear()
    .range([this.margins.left, width])
    .domain([1, this.data.length]);
};

/**
 * Set the min/max range for the Y axis
 * This takes into account the available space, minus margins,
 * and the min and max values found in the data array.
 */
LineGraph.prototype._setRangeY = function() {
  var height = this.height - this.margins.top;
  this.yRange = d3.scale.linear()
    .range([height, this.margins.bottom])
    .domain([d3.min(this.data), d3.max(this.data)]);
};


/**
 * Build an in-memory representation of our chart's line
 * using the data array.
 */
LineGraph.prototype._buildLine = function() {
  var self = this;
  var index = 0;
  var fn = d3.svg.line()
    .x(function(d) {
      index++;
      return self.xRange(index);
    })
    .y(function(d) {
      return self.yRange(d);
    })
    .interpolate('linear');
  return fn(self.data);
};

/**
 * Attach our line (generated by _buildLine()) to the DOM.
 */
LineGraph.prototype._appendLine = function() {
  this.$line = this.$chart.append('svg:path')
    .attr('d', this._buildLine())
    .attr('stroke', 'grey')
    .attr('stroke-width', 2)
    .attr('fill', 'none');
};

/**
 * Attach a new plot point to the DOM
 */
LineGraph.prototype._appendPoint = function(xCoord, yCoord) {
  this.$points.append("circle")
    .attr("cx", xCoord)
    .attr("cy", yCoord)
    .attr("r", 6);
};

/**
 * Generate a plot point for each data point in our data array.
 */
LineGraph.prototype._generatePoints = function() {
  this.$points = this.$chart.append('g');
  for (var i=0; i < this.data.length; i++) {
    var xCoord = this.xRange(i+1);
    var yCoord = this.yRange(this.data[i]);
    this._appendPoint(xCoord, yCoord);
  }
};



LineGraph.prototype._draw = function() {
  this._appendLine();
  this._generatePoints();
};

LineGraph.prototype.init = function() {
  this._setRangeX();
  this._setRangeY();
  this._appendAxisX();
  this._appendAxisY();
  this._draw();
};

LineGraph.prototype.reDraw = function() {
  this.$chart.selectAll("*").remove();
  this.init();
};



/**
 * Public method for adding another point to the chart.
 * The tickerMode argument is optional, and when set to true
 * will automatically remove the first data point to simulate
 * a moving ticker.
 */
LineGraph.prototype.addPoint = function(point, tickerMode) {
  if (tickerMode) {
    this.data.shift();
  }
  this.data.push(point);
  this.reDraw();
};
